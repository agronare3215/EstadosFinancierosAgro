<!doctype html>
<html lang="es-MX">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="theme-color" content="#16a34a" />
    <title>An√°lisis Financiero Integral ‚Äî Agronare</title>

    <!-- Manifest + Icons -->
    <link rel="manifest" href="/manifest.json" />
    <link rel="icon" href="/favicon.ico" />
    <link rel="icon" type="image/png" sizes="16x16" href="/public/icons/icon-16.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/public/icons/icon-32.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="/public/icons/icon-180.png" />

    <!-- CSS compilado -->
    <link rel="stylesheet" href="/dist/style.css" />

    <!-- Librer√≠as CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js" defer></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/exceljs@4.3.0/dist/exceljs.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js" defer></script>

    <!-- Ajustes r√°pidos locales (opcionales) -->
    <style>
        .tab-button.active {
            border-bottom-color: var(--brand);
            color: var(--brand);
            font-weight: 700
        }

        .input-field {
            width: 100%;
            max-width: 220px;
            background: #fff;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            padding: 6px 8px;
            text-align: right
        }

        .input-left {
            text-align: left
        }

        .card-title {
            font-weight: 700;
            color: var(--text, #0f172a)
        }

        .pdf-temp-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-bottom: 1px solid #e5e7eb;
            background: #fff
        }

        .sr-only {
            position: absolute !important;
            width: 1px !important;
            height: 1px !important;
            padding: 0 !important;
            margin: -1px !important;
            overflow: hidden !important;
            clip: rect(0, 0, 0, 0) !important;
            border: 0 !important
        }

        @media print {
            .no-print {
                display: none !important
            }
        }
    </style>
</head>

<body class="bg-gray-50 text-slate-900 antialiased">
    <main id="main-content" class="max-w-7xl mx-auto p-6 pb-12">
        <!-- HEADER -->
        <header class="flex flex-col md:flex-row md:items-center md:justify-between mb-4 gap-4 no-print" role="banner"
            aria-describedby="banner-desc">
            <div class="flex items-center gap-4">
                <img id="companyLogoImg" alt="Logo de Agronare" class="h-16 w-16 rounded-md shadow-sm" />
                <div>
                    <h1 id="app-title" class="text-2xl md:text-3xl font-bold text-green-700">An√°lisis Financiero
                        Integral</h1>
                    <p id="banner-desc" class="text-sm mt-0.5"><strong>Agronare</strong> ‚Äî Reportes profesionales con
                        logo en PDF y Excel. Interfaz accesible.</p>
                </div>
            </div>

            <div class="flex gap-2 flex-wrap no-print" role="toolbar" aria-label="Controles principales">
                <button id="btn-save-json" class="px-4 py-2 rounded-md border bg-emerald-600 text-white">Guardar
                    JSON</button>
                <button id="btn-export-xlsx" class="px-4 py-2 rounded-md border bg-green-700 text-white">Exportar
                    XLSX</button>
                <button id="btn-export-pdf" class="px-4 py-2 rounded-md border bg-sky-600 text-white">Exportar
                    PDF</button>
                <!-- Input real, oculto pero con soporte a lectores -->
                <input id="file-load" type="file" accept=".json" class="sr-only" aria-hidden="true" tabindex="-1" />

                <!-- El ‚Äúbot√≥n‚Äù accesible es el label -->
                <label for="file-load" id="btn-load-json" role="button"
                    class="px-4 py-2 rounded-md border bg-amber-500 text-white cursor-pointer">
                    Cargar JSON
                </label>

                JSON</button>
                <button id="btn-save-local" class="px-4 py-2 rounded-md border bg-emerald-500 text-white">Guardar en
                    navegador</button>
                <button id="btn-clear-local" class="px-4 py-2 rounded-md border bg-rose-500 text-white">Borrar
                    guardados</button>
                <button id="btn-reset" class="px-4 py-2 rounded-md border bg-gray-200">Reiniciar</button>
                <button id="btn-toggle-theme" class="px-3 py-2 rounded-md border ml-2 bg-gray-800 text-white"
                    title="Alternar modo" aria-pressed="false">üåô Oscuro</button>
            </div>
        </header>

        <div id="app-status" role="status" aria-live="polite" class="sr-only"></div>

        <!-- Opciones PDF -->
        <section aria-labelledby="pdf-options-title" class="bg-slate-50 p-3 rounded-lg border mb-4 no-print">
            <h3 id="pdf-options-title" class="font-bold mb-2">Opciones para PDF</h3>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
                <div>
                    <label for="pdfSize" class="text-sm">Tama√±o de p√°gina</label>
                    <select id="pdfSize" class="input-field input-left" aria-describedby="pdfSize-desc">
                        <option value="a4">A4</option>
                        <option value="letter">Letter</option>
                    </select>
                    <div id="pdfSize-desc" class="sr-only">Selecciona tama√±o.</div>
                </div>
                <div>
                    <label for="pdfOrientation" class="text-sm">Orientaci√≥n</label>
                    <select id="pdfOrientation" class="input-field input-left">
                        <option value="portrait">Vertical</option>
                        <option value="landscape">Horizontal</option>
                    </select>
                </div>
                <div>
                    <label for="pdfScale" class="text-sm">Escala render</label>
                    <input id="pdfScale" type="range" min="1" max="3" step="0.25" value="2" />
                    <div class="text-sm">Escala: <span id="pdfScaleVal">2.00</span>x</div>
                </div>
                <div>
                    <label class="text-sm">Incluir logo en encabezado</label>
                    <div><input id="pdfHeaderLogo" type="checkbox" checked /> <label for="pdfHeaderLogo">S√≠,
                            incluir</label></div>
                </div>
                <div>
                    <label class="text-sm">Marca de agua</label>
                    <div><input id="pdfWatermarkToggle" type="checkbox" checked /> <label
                            for="pdfWatermarkToggle">Activar</label></div>
                </div>
                <div>
                    <label for="pdfWatermarkText" class="text-sm">Texto marca</label>
                    <input id="pdfWatermarkText" class="input-field input-left" type="text" value="CONFIDENCIAL" />
                </div>
                <div>
                    <label for="pdfWatermarkOpacity" class="text-sm">Opacidad</label>
                    <input id="pdfWatermarkOpacity" type="range" min="0.03" max="0.5" step="0.01" value="0.12" />
                    <div class="text-sm">Opacidad: <span id="pdfWatermarkOpacityVal">0.12</span></div>
                </div>
                <div>
                    <label for="pdfWatermarkSize" class="text-sm">Tama√±o marca</label>
                    <input id="pdfWatermarkSize" type="range" min="24" max="160" step="2" value="72" />
                    <div class="text-sm">Tama√±o: <span id="pdfWatermarkSizeVal">72</span>px</div>
                </div>
                <div>
                    <label class="text-sm">Numeraci√≥n de p√°ginas</label>
                    <div><input id="pdfPageNumbersToggle" type="checkbox" checked /> <label
                            for="pdfPageNumbersToggle">Incluir n√∫meros</label></div>
                </div>
                <div>
                    <label for="pdfHeaderFont" class="text-sm">Fuente encabezado</label>
                    <input id="pdfHeaderFont" class="input-field input-left" type="text"
                        value="Inter, Arial, sans-serif" />
                </div>
            </div>
        </section>

        <!-- FORM: Datos generales -->
        <form id="main-form" role="form" aria-labelledby="form-title"
            class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <h2 id="form-title" class="sr-only">Formulario de datos financieros</h2>
            <div>
                <label for="companyName" class="text-sm">Empresa</label>
                <input id="companyName" class="w-full bg-slate-50 border rounded-lg px-3 py-2 mt-1 input-left"
                    value="Agronare S.A. de C.V." />
            </div>
            <div>
                <label for="reportDate" class="text-sm">Fecha del reporte</label>
                <input id="reportDate" type="date"
                    class="w-full bg-slate-50 border rounded-lg px-3 py-2 mt-1 input-left" />
            </div>
            <div>
                <label for="currencySelect" class="text-sm">Moneda</label>
                <select id="currencySelect" class="w-full bg-slate-50 border rounded-lg px-3 py-2 mt-1 input-left"
                    aria-label="Moneda">
                    <option value="MXN" selected>MXN</option>
                    <option value="USD">USD</option>
                </select>
            </div>
            <div>
                <label for="reportNotes" class="text-sm sr-only">Notas del reporte</label>
                <input id="reportNotes" class="w-full bg-slate-50 border rounded-lg px-3 py-2 mt-1 input-left"
                    placeholder="Notas (opcional)" />
            </div>
        </form>

        <!-- Opciones de reportes -->
        <section class="bg-slate-50 p-3 rounded-lg border mb-4 no-print">
            <h3 class="font-bold mb-2">Opciones de Reportes</h3>
            <div class="flex items-center gap-4">
                <div>
                    <label for="verticalAnalysisToggle" class="text-sm">An√°lisis Vertical</label>
                    <div class="mt-1 flex items-center">
                        <input id="verticalAnalysisToggle" type="checkbox" />
                        <label for="verticalAnalysisToggle" class="ml-2">Mostrar porcentajes (%) en reportes</label>
                    </div>
                </div>
                <div>
                    <label class="text-sm">Mostrar detalles</label>
                    <div class="mt-1">
                        <input id="expandDetailsToggle" type="checkbox" />
                        <label for="expandDetailsToggle" class="ml-2">Expandir partidas desglosadas</label>
                    </div>
                </div>
            </div>
        </section>

        <!-- TABS -->
        <nav aria-label="Secciones del reporte" class="mb-4 no-print">
            <div role="tablist" aria-label="Secciones del reporte"
                class="flex gap-2 border-b border-gray-200 flex-wrap">
                <button id="tab-datos" class="tab-button active px-4 py-2" role="tab" aria-controls="content-datos"
                    aria-selected="true" tabindex="0">1. Ingresar Datos</button>
                <button id="tab-balance" class="tab-button px-4 py-2" role="tab" aria-controls="content-balance"
                    aria-selected="false" tabindex="-1">2. Balance</button>
                <button id="tab-resultados" class="tab-button px-4 py-2" role="tab" aria-controls="content-resultados"
                    aria-selected="false" tabindex="-1">3. Estado Resultados</button>
                <button id="tab-flujos" class="tab-button px-4 py-2" role="tab" aria-controls="content-flujos"
                    aria-selected="false" tabindex="-1">4. Flujos</button>
                <button id="tab-patrimonio" class="tab-button px-4 py-2" role="tab" aria-controls="content-patrimonio"
                    aria-selected="false" tabindex="-1">5. Patrimonio</button>
                <button id="tab-graficos" class="tab-button px-4 py-2" role="tab" aria-controls="content-graficos"
                    aria-selected="false" tabindex="-1">6. Gr√°ficos y Ratios</button>
            </div>
        </nav>

        <!-- CONTENT -->
        <div id="content-container" role="region" aria-live="polite">
            <!-- DATOS -->
            <section id="content-datos" class="tab-content" role="tabpanel" aria-labelledby="tab-datos">
                <h3 class="sr-only">Ingreso de datos</h3>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="bg-slate-50 p-4 rounded-lg border" role="group" aria-labelledby="activos-title">
                        <h4 id="activos-title" class="card-title mb-2">ACTIVOS</h4>
                        <label for="caja" class="block text-sm">Caja</label>
                        <input id="caja" class="input-field" type="number" step="0.01" />
                        <label for="bancos" class="block text-sm mt-2">Bancos</label>
                        <input id="bancos" class="input-field" type="number" step="0.01" />
                        <label for="cxp" class="block text-sm mt-2">Cuentas por cobrar (CxC)</label>
                        <input id="cxp" class="input-field" type="number" step="0.01" />
                        <label for="inventarios" class="block text-sm mt-2">Inventarios</label>
                        <input id="inventarios" class="input-field" type="number" step="0.01" />
                        <label for="terrenos" class="block text-sm mt-2">Terrenos (bruto)</label>
                        <input id="terrenos" class="input-field" type="number" step="0.01" />
                        <label for="maquinaria" class="block text-sm mt-2">Maquinaria (bruto)</label>
                        <input id="maquinaria" class="input-field" type="number" step="0.01" />
                        <label for="vehiculos" class="block text-sm mt-2">Veh√≠culos (bruto)</label>
                        <input id="vehiculos" class="input-field" type="number" step="0.01" />
                        <label for="depreciacion_acum" class="block text-sm mt-2">Depreciaci√≥n acumulada</label>
                        <input id="depreciacion_acum" class="input-field" type="number" step="0.01" />
                        <label for="intangibles" class="block text-sm mt-2">Intangibles</label>
                        <input id="intangibles" class="input-field" type="number" step="0.01" />
                    </div>

                    <div class="bg-slate-50 p-4 rounded-lg border" role="group" aria-labelledby="pasivos-title">
                        <h4 id="pasivos-title" class="card-title mb-2">PASIVOS Y PATRIMONIO</h4>
                        <label for="proveedores" class="block text-sm">Proveedores</label>
                        <input id="proveedores" class="input-field" type="number" step="0.01" />
                        <label for="prestamos_cp" class="block text-sm mt-2">Pr√©stamos corto plazo</label>
                        <input id="prestamos_cp" class="input-field" type="number" step="0.01" />
                        <label for="impuestos_pagar" class="block text-sm mt-2">Impuestos por pagar</label>
                        <input id="impuestos_pagar" class="input-field" type="number" step="0.01" />
                        <label for="deuda_lp" class="block text-sm mt-2">Deuda largo plazo</label>
                        <input id="deuda_lp" class="input-field" type="number" step="0.01" />
                        <hr class="my-3" />
                        <label for="capital_social" class="block text-sm mt-2">Capital social</label>
                        <input id="capital_social" class="input-field" type="number" step="0.01" />
                        <label for="reservas" class="block text-sm mt-2">Reservas</label>
                        <input id="reservas" class="input-field" type="number" step="0.01" />
                        <label for="utilidades_retenidas" class="block text-sm mt-2">Utilidades retenidas
                            (inicio)</label>
                        <input id="utilidades_retenidas" class="input-field" type="number" step="0.01" />
                    </div>

                    <div class="bg-slate-50 p-4 rounded-lg border" role="group" aria-labelledby="er-title">
                        <h4 id="er-title" class="card-title mb-2">ESTADO DE RESULTADOS</h4>
                        <label for="ventas_net" class="block text-sm">Ventas netas</label>
                        <input id="ventas_net" class="input-field" type="number" step="0.01" />
                        <label for="devoluciones" class="block text-sm mt-2">Devoluciones</label>
                        <input id="devoluciones" class="input-field" type="number" step="0.01" />
                        <label for="costo_ventas" class="block text-sm mt-2">Costo de ventas</label>
                        <input id="costo_ventas" class="input-field" type="number" step="0.01" />
                        <hr class="my-3" />
                        <label for="gasto_sueldos" class="block text-sm mt-2">Sueldos</label>
                        <input id="gasto_sueldos" class="input-field" type="number" step="0.01" />
                        <label for="gasto_renta" class="block text-sm mt-2">Renta</label>
                        <input id="gasto_renta" class="input-field" type="number" step="0.01" />
                        <label for="gasto_marketing" class="block text-sm mt-2">Marketing</label>
                        <input id="gasto_marketing" class="input-field" type="number" step="0.01" />
                        <label for="gasto_intereses" class="block text-sm mt-2">Intereses</label>
                        <input id="gasto_intereses" class="input-field" type="number" step="0.01" />
                        <label for="impuestos_calc" class="block text-sm mt-2">Impuestos estimados</label>
                        <input id="impuestos_calc" class="input-field" type="number" step="0.01" />
                    </div>
                </div>

                <!-- Flujos / Inversi√≥n / Financiaci√≥n -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mt-6">
                    <div class="bg-slate-50 p-4 rounded-lg border" role="group" aria-labelledby="flujos-title">
                        <h4 id="flujos-title" class="card-title mb-2">Flujos de operaci√≥n</h4>
                        <p class="text-sm text-slate-500">Ingresa cambios en capital de trabajo para el ajuste
                            indirecto. Œî (aumento = +)</p>
                        <label for="delta_cxc" class="block text-sm mt-2">Œî CxC (Cuentas por Cobrar)</label>
                        <input id="delta_cxc" class="input-field" type="number" step="0.01" />
                        <label for="delta_inventarios" class="block text-sm mt-2">Œî Inventarios</label>
                        <input id="delta_inventarios" class="input-field" type="number" step="0.01" />
                        <label for="delta_cxp" class="block text-sm mt-2">Œî CxP (Cuentas por Pagar)</label>
                        <input id="delta_cxp" class="input-field" type="number" step="0.01" />
                        <p class="text-sm mt-2 text-slate-500">Explicaci√≥n: <strong>CxC</strong> ventas a√∫n no cobradas;
                            <strong>CxP</strong> compras/obligaciones no pagadas.
                        </p>
                    </div>

                    <div class="bg-slate-50 p-4 rounded-lg border" role="group" aria-labelledby="inversion-title">
                        <h4 id="inversion-title" class="card-title mb-2">Inversi√≥n</h4>
                        <label for="capex" class="block text-sm">CAPEX (compras)</label>
                        <input id="capex" class="input-field" type="number" step="0.01" />
                        <p class="text-sm text-slate-500 mt-1">Compras de activos fijos. Salida en flujos de inversi√≥n.
                        </p>
                        <label for="venta_activo" class="block text-sm mt-2">Venta de activos</label>
                        <input id="venta_activo" class="input-field" type="number" step="0.01" />
                        <p class="text-sm text-slate-500 mt-1">Ingreso por desinversi√≥n (venta equipo/veh√≠culo).</p>
                    </div>

                    <div class="bg-slate-50 p-4 rounded-lg border" role="group" aria-labelledby="financ-title">
                        <h4 id="financ-title" class="card-title mb-2">Financiaci√≥n</h4>
                        <label for="deuda_emitida" class="block text-sm">Deuda emitida</label>
                        <input id="deuda_emitida" class="input-field" type="number" step="0.01" />
                        <p class="text-sm text-slate-500 mt-1">Pr√©stamos/cr√©dito recibido (entrada de efectivo).</p>
                        <label for="deuda_pagada" class="block text-sm mt-2">Deuda pagada</label>
                        <input id="deuda_pagada" class="input-field" type="number" step="0.01" />
                        <p class="text-sm text-slate-500 mt-1">Amortizaciones o pagos (salida de efectivo).</p>
                        <label for="dividendos_pag" class="block text-sm mt-2">Dividendos pagados</label>
                        <input id="dividendos_pag" class="input-field" type="number" step="0.01" />
                        <p class="text-sm text-slate-500 mt-1">Distribuciones a propietarios (salida de efectivo).</p>
                    </div>
                </div>
            </section>

            <!-- Secciones generadas -->
            <section id="content-balance" class="tab-content hidden print-section mt-6" role="tabpanel"
                aria-labelledby="tab-balance"></section>
            <section id="content-resultados" class="tab-content hidden print-section mt-6" role="tabpanel"
                aria-labelledby="tab-resultados"></section>
            <section id="content-flujos" class="tab-content hidden print-section mt-6" role="tabpanel"
                aria-labelledby="tab-flujos"></section>
            <section id="content-patrimonio" class="tab-content hidden print-section mt-6" role="tabpanel"
                aria-labelledby="tab-patrimonio"></section>

            <!-- GRAFICOS -->
            <section id="content-graficos" class="tab-content hidden mt-6" role="tabpanel"
                aria-labelledby="tab-graficos">
                <h3 class="text-xl font-bold mb-4">Gr√°ficos y Ratios Financieros</h3>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-slate-50 p-4 rounded-lg border h-72">
                        <h4 class="font-semibold mb-2">Activos vs Pasivos y Patrimonio</h4>
                        <canvas id="chart-balance" class="h-52" aria-label="Gr√°fico comparativo"></canvas>
                    </div>
                    <div class="bg-slate-50 p-4 rounded-lg border h-72">
                        <h4 class="font-semibold mb-2">Composici√≥n del Resultado</h4>
                        <canvas id="chart-result" class="h-52" aria-label="Gr√°fico de composici√≥n"></canvas>
                    </div>
                </div>

                <div class="mt-4 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
                    <div class="bg-white p-4 border rounded-lg text-center">
                        <div class="text-sm text-slate-500">Raz√≥n Circulante</div>
                        <div id="ratio-liquidez" class="text-2xl font-bold mt-1">-</div>
                    </div>
                    <div class="bg-white p-4 border rounded-lg text-center">
                        <div class="text-sm text-slate-500">Endeudamiento</div>
                        <div id="ratio-endeudamiento" class="text-2xl font-bold mt-1">-</div>
                    </div>
                    <div class="bg-white p-4 border rounded-lg text-center">
                        <div class="text-sm text-slate-500">Margen Neto</div>
                        <div id="ratio-margen" class="text-2xl font-bold mt-1">-</div>
                    </div>
                    <div class="bg-white p-4 border rounded-lg text-center">
                        <div class="text-sm text-slate-500">ROA</div>
                        <div id="ratio-roa" class="text-2xl font-bold mt-1">-</div>
                    </div>
                    <div class="bg-white p-4 border rounded-lg text-center">
                        <div class="text-sm text-slate-500">ROE</div>
                        <div id="ratio-roe" class="text-2xl font-bold mt-1">-</div>
                    </div>
                </div>
            </section>
        </div>

        <div class="mt-6 flex justify-center gap-3 no-print">
            <button id="btn-preview" class="px-4 py-2 rounded-md bg-indigo-600 text-white">Actualizar &
                Previsualizar</button>
        </div>
    </main>

    <!-- Loader -->
    <div id="loader" class="fixed inset-0 bg-white bg-opacity-80 items-center justify-center hidden z-50" role="status"
        aria-live="assertive">
        <div class="w-16 h-16 border-8 border-dashed rounded-full animate-spin border-green-600"></div>
        <p class="mt-4 text-lg font-semibold text-green-700">Procesando...</p>
    </div>

    <!-- Script principal -->
    <script src="/src/main.js" defer></script>

    <!-- Registro √∫nico del Service Worker -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(reg => console.log('ServiceWorker registrado:', reg.scope))
                    .catch(err => console.warn('ServiceWorker error:', err));
            });
        }
    </script>
</body>

</html>